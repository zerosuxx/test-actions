name: PrSync

on:
  pull_request:
    types:
      - opened
      - synchronize
      - closed

env:
  FOLDER_LIST: 'infra/dev,infra/staging,infra/prod'
  TOOLS: |
    terraform 1.10.3
    terragrunt 0.71.1

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.modified-files.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: test
        run: echo '${{ toJSON(github) }}'
      - name: modified files
        id: modified-files
        run: |
          modified_files=$(git diff --name-only origin/master)

          affected_folders=()
          # for folder in $(echo ${FOLDER_LIST} | sed "s/,/ /g")
          # do
          #   if echo "$modified_files" | grep -q "${folder}"; then
          #     affected_folders+=("$folder")
          #   fi
          # done

          echo "matrix=$(jq -c -n '{folder: $ARGS.positional}' --args "${affected_folders[@]}")" | tee -a $GITHUB_OUTPUT

  plan:
    needs: prepare
    runs-on: ubuntu-latest
    if: contains(fromJSON('["opened", "synchronize"]'), github.event.action)
    strategy:
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      
      - uses: jdx/mise-action@v2
        with:
          tool_versions: ${{ env.TOOLS }}
  
      - run: "terragrunt run-all plan --terragrunt-out-dir /tmp/tfplan --terragrunt-working-dir ${{ matrix.folder }}"

